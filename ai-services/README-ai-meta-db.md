# AI Meta DB Schema Documentation

This document describes the schema and structure for the `ai-meta-db` used by the Bank of Anthos AI agent microservices (`anomaly-sage` and `transaction-sage`).

## Overview
The `ai-meta-db` is a PostgreSQL database designed to support:
- Transaction categorization and logging
- Anomaly detection and risk analysis
- Budget tracking and usage per user and category

## Tables

### 1. anomaly_logs
Logs risk analysis and classification results from `anomaly-sage`.
| Column         | Type      | Description                                 |
|---------------|-----------|---------------------------------------------|
| log_id        | UUID      | Primary key                                 |
| transaction_id| bigint    | Reference to transaction                    |
| account_id    | character(10) | User account identifier                  |
| risk_score    | float     | Calculated risk score                       |
| status        | varchar   | Classification: normal, suspicious, fraud   |
| created_at    | timestamp without time zone | Log creation time         |

### 2. transaction_logs
Logs transaction details and categorization from `transaction-sage`.
| Column         | Type      | Description                                 |
|---------------|-----------|---------------------------------------------|
| id            | UUID      | Primary key                                 |
| transaction_id| bigint    | Reference to transaction                    |
| account_id    | character(10) | User account identifier                  |
| amount        | integer   | Transaction amount (in cents)                |
| category      | varchar   | Transaction category (food, travel, etc.)   |
| created_at    | timestamp without time zone | Log creation time         |

### 3. budgets
Tracks budget allocations per user and category.
| Column         | Type      | Description                                 |
|---------------|-----------|---------------------------------------------|
| id            | UUID      | Primary key                                 |
| account_id    | character(10) | User account identifier                  |
| category      | varchar   | Budget category                             |
| budget_limit  | integer   | Allocated budget amount (in cents)           |
| period_start  | date      | Budget period start date                    |
| period_end    | date      | Budget period end date                      |

### 4. budget_usage
Tracks budget usage per user and category.
| Column         | Type      | Description                                 |
|---------------|-----------|---------------------------------------------|
| id            | UUID      | Primary key                                 |
| account_id    | character(10) | User account identifier                  |
| category      | varchar   | Budget category                             |
| used_amount   | integer   | Amount used in the period (in cents)         |
| period_start  | date      | Usage period start date                     |
| period_end    | date      | Usage period end date                       |

### 5. user_profiles
User profile and risk analysis configuration for anomaly detection.
| Column | Type | Constraints / Default |
| --- | --- | --- |
| profile_id | UUID | PK, DEFAULT `uuid_generate_v4()` |
| account_id | CHARACTER(10) | UNIQUE, FK → users(accountid) |
| mean_txn_amount | INTEGER | Average amount in cents |
| stddev_txn_amount | INTEGER | Std dev in cents |
| active_hours | INTEGER[] | Array of hours (0–23) |
| threshold_suspicious_multiplier | NUMERIC | DEFAULT `2.0` |
| threshold_fraud_multiplier | NUMERIC | DEFAULT `3.0` |
| email_for_alerts | TEXT | Optional email contact |
| created_at | TIMESTAMPTZ | DEFAULT `now()` |

### 6. pending_confirmations
Stores pending transaction confirmations for anomaly-sage.
| Column | Type | Constraints / Default |
| --- | --- | --- |
| confirmation_id | UUID | PK, DEFAULT `uuid_generate_v4()` |
| account_id | CHARACTER(10) | NOT NULL |
| payload | JSONB | NOT NULL |
| requested_at | TIMESTAMPTZ | DEFAULT `now()` |
| expires_at | TIMESTAMPTZ | NOT NULL |
| status | TEXT | CHECK (status IN ('pending','confirmed','expired','cancelled')), DEFAULT 'pending' |
| confirmation_method | TEXT | Optional |

## Relationships
- `anomaly_logs.transaction_id` and `transaction_logs.transaction_id` reference the same transaction.
- `budgets` and `budget_usage` are linked by `account_id` and `category`.

## Usage
- `anomaly-sage` writes to `anomaly_logs` after risk analysis.
- `transaction-sage` writes to `transaction_logs` after transaction execution and categorization, and updates `budget_usage`.
- Budget limits are managed in `budgets`.

## Notes
- All UUIDs should be generated by the service layer.
- Timestamps are in UTC.
- Categories are string labels (e.g., food, travel, shopping).

## Example Workflow
1. A transaction is executed and logged in `transaction_logs`.
2. `anomaly-sage` analyzes the transaction and logs the result in `anomaly_logs`.
3. `transaction-sage` categorizes the transaction and updates `budget_usage`.
4. Budget limits are checked against `budgets`.

---
For further details, see the service documentation in `docs/` and the schema migration scripts in `ai-services/migrations/`.
